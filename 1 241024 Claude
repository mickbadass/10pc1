using Linnworks.Core;
using System;
using System.Linq;

[Macro("10PcDiscount")]  // This line is important - must match your MacroName parameter
public class DiscountMacro
{
    private readonly ILinnworksAPI _api;
    private const string DISCOUNT_NOTE = "10PC_DISCOUNT_APPLIED";

    [MacroEntryPoint] // Add this attribute to specify the entry point
    public void Execute(ILinnworksAPI api)
    {
        _api = api;
        ApplyDiscount();
    }

    private void ApplyDiscount()
    {
        // Rest of the code stays the same
        var orders = _api.Orders.GetOpenOrders()
            .Where(o => o.PaymentMethod == "Decco10pc");

        foreach (var order in orders)
        {
            var orderNotes = _api.Orders.GetOrderNotes(order.OrderId);
            if (orderNotes.Any(n => n.Note.Contains(DISCOUNT_NOTE)))
            {
                continue;
            }

            bool discountApplied = false;
            foreach (var item in order.Items)
            {
                try
                {
                    decimal newPrice = Math.Round(item.Price * 0.9m, 2);
                    
                    _api.Orders.UpdateOrderItemPrice(
                        orderId: order.OrderId,
                        orderItemId: item.OrderItemId,
                        newPrice: newPrice
                    );
                    
                    discountApplied = true;
                }
                catch (Exception ex)
                {
                    _api.Logger.WriteError("Discount Application Error", 
                        $"Failed to apply discount to Order {order.OrderId}, Item {item.OrderItemId}: {ex.Message}");
                }
            }

            if (discountApplied)
            {
                _api.Orders.AddOrderNote(
                    orderId: order.OrderId,
                    note: $"{DISCOUNT_NOTE} - Applied on {DateTime.Now}",
                    isInternal: true
                );
            }
        }
    }
}
